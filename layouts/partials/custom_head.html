{{/* --- Theme toggle script (must load before body for instant theme application) --- */}}
<script src="/js/theme-toggle.js"></script>
<script>
// Debug: Verify theme toggle loaded and force initial theme check
console.log('[Debug] Theme toggle script loaded:', typeof window.themeToggle !== 'undefined');
console.log('[Debug] HTML classes:', document.documentElement.className);
console.log('[Debug] Effective theme:', window.themeToggle ? window.themeToggle.getEffective() : 'not available');
</script>

{{/* --- Load SCSS via Hugo Pipes (new API) --- */}}
{{- $sass := resources.Get "scss/main.scss" -}}
{{- $enableSourceMap := not hugo.IsProduction -}}
{{- $css := $sass
| css.Sass (dict "targetPath" "css/site.css" "enableSourceMap" $enableSourceMap)
| resources.Minify -}}
<link rel="stylesheet" href="{{ $css.RelPermalink }}">

{{/* --- Load any additional plain CSS via customCSS param (for legacy styles during migration) --- */}}
{{- with .Site.Params.customCSS -}}
{{- range . -}}
<link rel="stylesheet" href="{{ . | absURL }}">
{{- end -}}
{{- end -}}

{{/* --- Load any custom JS as before --- */}}
{{- with .Site.Params.customJS -}}
{{- range . -}}
<script defer src="{{ . | absURL }}"></script>
{{- end -}}
{{- end -}}

{{/* --- Preview flag detection (prod-only, must load before analytics) --- */}}
{{- if hugo.IsProduction -}}
<script src="/js/preview-flag.js"></script>
{{- end -}}

{{/* --- Google Analytics 4 with preview mode support, prod-only --- */}}
{{- if hugo.IsProduction -}}
{{- with site.Config.Services.GoogleAnalytics.ID -}}
{{- partial "google_analytics_with_preview.html" $ -}}
{{- end -}}
{{- end -}}